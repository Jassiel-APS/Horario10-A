<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icons/icon-192x192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <meta name="msapplication-TileImage" content="./icons/icon-144x144.png">
  <meta name="theme-color" content="#0b0f17">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Horario 10°A‑IDGS · Sep–Dic 2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f17;          /* fondo principal */
      --panel:#101827;       /* paneles oscuros */
      --panel-2:#0f1624;     /* bordes/sombras */
      --text:#dce7ff;        /* texto primario */
      --muted:#8ea3c7;       /* texto secundario */
      --grid:#1a2740;        /* líneas de la grilla */
      --glow: 0 0 0px rgba(0,0,0,0);
      /* Colores por materia (neón oscuro estilo gamer) */
  /* colores con mayor contraste y tonalidades diferenciadas */
  --c-apps: linear-gradient(135deg,#00c38a,#007b5e);
  --c-gestion: linear-gradient(135deg,#1f8cff,#005bb5);
  --c-movil: linear-gradient(135deg,#5d63ff,#2a1cff);
  --c-integradora: linear-gradient(135deg,#ff6fb1,#b84dff);
  --c-optativa: linear-gradient(135deg,#9a00ff,#00d6f0);
  --c-nego: linear-gradient(135deg,#ff5e6c,#ff8a3d);
  --c-ingles: linear-gradient(135deg,#23d6b4,#017f73);
    }
    /* Tema claro/diurno (sobrescribe variables) */
    .light-theme{
      --bg: #f6f9ff;
      --panel: #ffffff;
      --panel-2: #f0f6ff;
      --text: #0b1a2b;
      --muted: #516a86;
      --grid: #d7e3f7;
    }
    /* Overrides para elementos que usaban fondos semitransparentes oscuros */
    .light-theme #scheduleMenu{
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(10,20,40,0.06);
      box-shadow: 0 10px 30px rgba(20,40,80,0.06);
      color: var(--text);
    }
    .light-theme #scheduleMenu .menu-desc{ color:var(--muted); }
    .light-theme .menu-actions button.chip{ background: linear-gradient(180deg, rgba(125,91,255,0.06), rgba(125,91,255,0.03)); color:var(--text); }
    .light-theme .card{ background: var(--panel); border:1px solid rgba(10,30,60,0.06); box-shadow:0 8px 22px rgba(15,30,60,0.04); color:var(--text) }
    .light-theme .card:before{ background: linear-gradient(120deg, transparent, rgba(10,20,40,0.03), transparent); }
    .light-theme .legend{ background: transparent }
    .light-theme .mini{ color:var(--text); box-shadow: inset 0 0 0 1px rgba(3,12,30,0.02), 0 8px 18px rgba(10,20,40,0.03) }
    /* Spinner más oscuro en tema claro */
    .light-theme .spinner{ border:2px solid rgba(0,0,0,0.08); border-top-color: rgba(0,0,0,0.45); }

    /* Animaciones: adaptar brillo/colores para que funcionen sobre fondo claro */
    .light-theme .now.animated::after{ background: radial-gradient(600px 200px at 20% 0%, rgba(125,91,255,0.14), transparent 40%); mix-blend-mode: multiply; }
    .light-theme .near.animated::after{ background: linear-gradient(90deg, rgba(0,0,0,0.02), rgba(0,0,0,0.04), rgba(0,0,0,0.02)); }
    .light-theme .next.animated::after{ background: radial-gradient(600px 200px at 20% 0%, rgba(125,91,255,0.06), transparent 40%); }
    .light-theme .now.animated{ box-shadow:0 10px 30px rgba(125,91,255,0.06); }
    .light-theme .near.animated{ box-shadow:0 8px 20px rgba(0,0,0,0.05); }
    /* En modo diurno: overlay más visible del color de la materia sobre la card 'now'.
       Añadimos una capa difusa + una capa de brillo sutil con pulso para resaltar el color
       sin tocar las reglas ni animaciones del modo nocturno. Respeta prefers-reduced-motion. */
    @keyframes subtlePulse { 0% { transform: scale(1); opacity: 0.42 } 50% { transform: scale(1.03); opacity: 0.58 } 100% { transform: scale(1); opacity: 0.42 } }

    .light-theme .card.now::before{
      content: '';
      position: absolute; inset: 0; border-radius: 16px; pointer-events: none;
      /* usar gradiente si existe, sino la versión con alpha de acento; intensidad media */
      background: var(--subject-bg, var(--subject-accent, rgba(125,91,255,0.22)));
      opacity: 0.45; /* intensidad media: ni muy fuerte ni muy leve */
      filter: blur(6px) saturate(1.08);
      mix-blend-mode: multiply;
      transition: opacity .22s ease, transform .22s ease;
      z-index: 0;
    }
    /* fina capa extra para dar brillo y textura encima del tintado (muy sutil) */
    .light-theme .card.now::after{
      content: '';
      position: absolute; inset: 6px; border-radius: 12px; pointer-events: none;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      opacity: 0.12;
      transform: translateZ(0);
      transition: transform .28s ease, opacity .28s ease;
      z-index: 0;
    }
    /* animar ligeramente solo si el card tiene la clase .animated (preserva reduced-motion) */
    .light-theme .card.now.animated::before{ animation: subtlePulse 2.6s ease-in-out infinite; }

    @media (prefers-reduced-motion: reduce){
      .light-theme .card.now.animated::before{ animation: none; }
    }

   /* asegurar que el contenido textual de la card quede por encima del overlay
     (evitar aplicar position:relative a elementos absolutamente posicionados
     como .badge, ya que en tema claro provocaba que el badge perdiera su
     posicionamiento y apareciera dentro del flujo). */
   .light-theme .card.now .title,
   .light-theme .card.now .meta,
   .light-theme .card.now .chip { position: relative; z-index: 1 }
    /* Intensificar color del card actual en modo diurno usando --subject-accent (inline desde JS)
       Aplicamos un overlay tintado a la propia tarjeta (no al texto) para que el color se vea
       en el fondo de la card; mantenemos la legibilidad del texto por encima. */
    .light-theme .card.now{
      border: 1px solid rgba(0,0,0,0.04);
      /* sombra externa suave con color ligeramente mezclado para dar presencia sin saturar */
      box-shadow: 0 18px 40px rgba(0,0,0,0.06), 0 6px 18px rgba(0,0,0,0.04);
      background: var(--panel);
    }
    /* reforzar el tintado del fondo mediante el pseudo-elemento ::before (más visible en modo claro) */
    /* (nota: ::before ya definida arriba con más intensidad; aquí dejamos una ligera compatibilidad)
       No duplicar comportamiento; la primera definición controla el tintado final. */
    /* mantener el brillo/textura fina encima del tintado */
    .light-theme .card.now::after{ opacity: 0.12 }

    /* Asegurar que los iconos se coloreen correctamente en tema claro */
    .light-theme .icon-btn svg{ color: var(--muted); }
    /* transición suave al cambiar tema */
    html, body, .card, .mini, .chip, button{ transition: background-color 220ms ease, color 220ms ease, border-color 220ms ease, box-shadow 220ms ease; }
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:var(--text);
      /* fondo principal — fijo para evitar recortes al cambiar contenido */
      background: radial-gradient(1200px 800px at 20% -10%, #10213b55, transparent),
                  radial-gradient(1000px 600px at 120% 10%, #401a7550, transparent),
                  var(--bg);
      min-height:100vh;
      background-attachment:fixed;
      background-size:cover;
    }
  /* contenedor: no forzar altura, dejar que el contenido fluya; padding inferior reducido */
  .wrap{max-width:1060px; margin:0 auto; padding:24px 16px 32px; min-height:auto}
    header h1{margin:0; font-size:clamp(20px,2.6vw,28px); letter-spacing:-.2px}
    header p{margin:.25rem 0 0; color:var(--muted); font-size:14px}
    .toolbar{margin-top:18px; display:flex; gap:10px; flex-wrap:wrap}
    button, select{
      background:var(--panel); color:var(--text); border:1px solid #223150; border-radius:12px;
      padding:10px 14px; font-weight:600; letter-spacing:.2px; cursor:pointer;
    }
    button:hover{filter:brightness(1.05)}
    .ghost{background:transparent}
  .icon-btn{width:46px;height:46px;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;padding:8px}
  .icon-btn svg{color:var(--muted); width:20px;height:20px}

  /* Tema toggle button: visualmente igual a otros icon-btn */
  #btnToggleTheme{ width:46px; height:46px; display:inline-flex; align-items:center; justify-content:center; border-radius:12px; padding:8px; background:var(--panel); border:1px solid #223150; color:var(--muted); }
  /* label hidden to match other toolbar icons */
  .btn-label{ display:none }
  /* mostrar icono de sol en tema claro, luna en tema oscuro */
  .icon-sun{ display:none }
  .icon-moon{ display:none }
  .light-theme .icon-sun{ display:inline }
  body:not(.light-theme) .icon-moon{ display:inline }
  /* focus visible */
  #btnToggleTheme:focus{ outline:3px solid rgba(125,91,255,0.12); outline-offset:2px }

  /* Vista móvil: lista por día */
  .day-view{display:grid; gap:12px; margin-top:20px}
    .day-picker{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .subtitle{color:var(--muted); font-size:13px}

  .card{border-radius:16px; padding:20px 20px; background:var(--panel); border:1px solid #1a2a47; position:relative; overflow:hidden}
  /* más espacio entre cards en móvil */
  @media (max-width:899px){ .day-view .card{margin-bottom:12px} }
    .card:before{content:""; position:absolute; inset:-1px; border-radius:16px; padding:1px; background:linear-gradient(120deg,transparent,rgba(255,255,255,.06),transparent); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite:exclude; mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); pointer-events:none; }
  .card .title{font-weight:700; font-size:19px; line-height:1.05}
  .card .meta{font-size:14px; color:var(--muted)}
    .chip{display:inline-block; font-size:11px; padding:.22rem .5rem; border-radius:999px; background:#0c1430; border:1px solid #1c2b52; color:#b9cffb}

    /* Badge de color */
    .badge{position:absolute; inset:auto 14px 14px auto; font-size:12px; padding:.36rem .6rem; border-radius:10px; font-weight:700; color:#051016;
      box-shadow:0 8px 24px rgba(0,0,0,.45)}
    .apps{background:var(--c-apps)}
    .gestion{background:var(--c-gestion)}
    .movil{background:var(--c-movil)}
    .integ{background:var(--c-integradora)}
    .optativa{background:var(--c-optativa)}
    .nego{background:var(--c-nego)}
    .ingles{background:var(--c-ingles)}

    /* Resaltado de clase actual */
    .now{outline:1px solid rgba(255,255,255,.15); box-shadow:0 0 0 2px #92a7ff2e, 0 0 24px #7d5bff55}
    .now .title{filter:drop-shadow(0 2px 10px #7a59ff88)}
  /* siguiente clase destacada (leve) */
  .next{box-shadow:0 8px 18px rgba(0,0,0,.45); transform:scale(1.005); border:1px solid rgba(255,255,255,.04)}
  /* estados de alumbrado: dim (lejano), near (casi), now (actual) */
  .dim{opacity:0.65; filter:grayscale(.15) brightness(.9); transform:none}
  /* Evitar desplazamiento vertical que provoca desalineación visual al resaltar
    (antes se usaba translateY negativo). Ahora sólo escalamos levemente para
    mantener el énfasis sin mover el flujo del documento. Esto corrige el
    efecto "desfasado" respecto al encabezado/tiempo actual en vista móvil. */
  .near{opacity:0.94; transform:scale(1.01); box-shadow:0 10px 24px rgba(0,0,0,.32)}
  .now{opacity:1; transform:scale(1.02); box-shadow:0 18px 48px rgba(122,89,255,.22); border:1px solid rgba(255,255,255,.06)}

  /* Animaciones para indicar actividad */
  @keyframes pulseGlow{ 0%{ box-shadow:0 6px 18px rgba(122,89,255,0.12)} 50%{ box-shadow:0 22px 56px rgba(122,89,255,0.28)} 100%{ box-shadow:0 6px 18px rgba(122,89,255,0.12)} }
  @keyframes shimmer{ 0%{ background-position: -200% 0 } 100%{ background-position: 200% 0 } }

  .now.animated{ animation: pulseGlow 2s ease-in-out infinite; }
  .near.animated{ background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.06) 50%, rgba(255,255,255,0.03) 100%); background-size: 200% 100%; animation: shimmer 3s linear infinite; }
  /* next (siguiente) - brillo leve y animado */
  .next.animated{ background: linear-gradient(90deg, rgba(255,255,255,0.015) 0%, rgba(255,255,255,0.035) 50%, rgba(255,255,255,0.015) 100%); background-size:200% 100%; animation: shimmer 4s linear infinite; box-shadow:0 10px 30px rgba(125,89,255,0.08); }
  .next{ transform:scale(1.005); }

  /* Respect user preference for reduced motion */
  @media (prefers-reduced-motion: reduce){
    .now.animated, .near.animated{ animation: none; }
  }

  /* Mobile-friendly overlay animations using pseudo-element (better performance) */
  .now.animated::after, .near.animated::after{
    content: '';
    position: absolute; inset:0; border-radius:16px; pointer-events:none; opacity:0; transition:opacity .35s ease;
  }
  .now.animated::after{ background: radial-gradient(600px 200px at 20% 0%, rgba(125,91,255,0.18), transparent 40%); animation: pulseGlow 2.4s ease-in-out infinite; }
  .near.animated::after{ background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.05), rgba(255,255,255,0.02)); background-size:200% 100%; animation: shimmer 3s linear infinite; }
  .next.animated::after{ background: radial-gradient(600px 200px at 20% 0%, rgba(125,91,255,0.08), transparent 40%); animation: none; }
  .now.animated::after, .near.animated::after{ opacity:1 }

    /* Vista escritorio: grid semanal */
    .week{display:none}
    @media (min-width:900px){
      .day-view{display:none}
      .week{display:grid; margin-top:18px; border:1px solid #15233f; border-radius:14px; overflow:hidden; background:linear-gradient(#0c1220,#0c1220) padding-box, linear-gradient(120deg,#223459,#0f1a30) border-box}
      .week .header{display:grid; grid-template-columns:120px repeat(5,1fr); background:#0f1628; border-bottom:1px solid #182744}
      .week .header div{padding:12px 14px; font-weight:700; color:#c8d7ff; font-size:14px}
      .week .row{display:grid; grid-template-columns:120px repeat(5,1fr)}
      .hour{padding:12px 10px; color:#9bb2da; font-size:12px; text-align:right; border-right:1px solid #182744; background:#0b1324}
      .cell{min-height:76px; border-left:1px solid #182744; border-bottom:1px dashed #1b2b4d; padding:8px}
    .mini{padding:10px; border-radius:10px; color:#fff; font-weight:700; font-size:12px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 10px 26px rgba(0,0,0,.45)}
      .mini{position:relative}
      .mini .when{display:block; margin-top:4px; font-weight:600; font-size:11px; color:#091528}
      .mini .room{display:block; margin-top:2px; font-weight:600; font-size:10px; opacity:.85}
    }

    /* Leyenda */
  .legend{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:18px}
  /* ocultar leyenda por defecto en móvil */
  @media (max-width:899px){ .legend{display:none} .legend.open{display:grid} }
    .legend .item{display:flex; gap:10px; align-items:center}
    .swatch{width:16px; height:16px; border-radius:6px}
    .swatch{display:inline-block; background-size:cover; background-position:center; width:18px; height:18px; box-shadow:0 6px 18px rgba(0,0,0,0.25)}
    .day-picker{z-index:40}
    .toolbar{position:relative; z-index:20}

  /* Schedule menu styles */
    #scheduleMenu{ padding:14px; max-width:360px; display:flex; flex-direction:column; align-items:stretch; gap:8px;
      background: rgba(12,18,30,0.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,0.04);
      border-radius:12px;
      box-shadow:0 12px 40px rgba(2,6,23,0.6);
      min-width:260px;
      transition: transform 180ms ease, opacity 180ms ease;
      opacity:0; transform:translateY(-8px); pointer-events:none;
    }
    #scheduleMenu.show{ opacity:1; transform:none; pointer-events:auto }
  #scheduleMenu .menu-header{ display:flex; align-items:center; justify-content:space-between; gap:8px }
  #scheduleMenu .menu-title{ font-weight:800; font-size:15px; color:var(--text) }
  #scheduleMenu .menu-desc{ font-size:13px; color:var(--muted); margin-top:6px }
  #scheduleList{ margin-top:12px; display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto; padding-right:4px }
  .schedule-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.012), transparent); border:1px solid rgba(255,255,255,0.02); cursor:pointer }
  .schedule-item:hover{ transform:translateY(-3px); box-shadow:0 10px 30px rgba(0,0,0,.4) }
  .schedule-item.selected{ outline:2px solid rgba(125,91,255,0.18); box-shadow:0 14px 40px rgba(125,91,255,0.06) }
  .schedule-meta{ font-size:12px; color:var(--muted) }
  .menu-actions{ display:flex; gap:8px; margin-top:10px; justify-content:flex-end }
  .menu-actions button{ padding:8px 12px; border-radius:8px }

    /* mini-specific overlay radius */
    .mini.now.animated::after, .mini.near.animated::after{ border-radius:10px }
    /* realce temporal para inicio de semana en vista semanal */
    .start-highlight{ outline:3px solid rgba(125,91,255,0.14); box-shadow:0 12px 30px rgba(125,91,255,0.06); }
  /* botón de 'Ver inicio de semana' más visible */
  #btnGotoStartWeek{ padding:10px 14px; font-size:14px; border-radius:10px; background:linear-gradient(180deg, rgba(125,91,255,0.12), rgba(125,91,255,0.06)); border:1px solid rgba(125,91,255,0.12); color:var(--text); cursor:pointer }
  #btnGotoStartWeek:hover{ transform:translateY(-2px); box-shadow:0 10px 30px rgba(125,91,255,0.06) }
  /* spinner pequeño para acciones */
  .spinner{ display:inline-block; width:12px; height:12px; border:2px solid rgba(255,255,255,0.18); border-top-color:rgba(255,255,255,0.9); border-radius:50%; margin-right:8px; vertical-align:middle; animation:spin .9s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  /* estado loading en botones */
  .chip.loading{ opacity:0.9; transform:none; pointer-events:none }
  </style>
</head>
<body>
  <div class="wrap">
    <header id="appHeader">
      <!-- En móvil mostraremos día, fecha y hora en tiempo real -->
      <div id="mobileHeader" style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="currentDay" style="font-weight:700;font-size:18px"></div>
            <div id="currentDate" style="color:var(--muted);font-size:13px"></div>
          <!-- (Tema) moved into toolbar to match other controls -->
          </div>
          <div style="text-align:right">
            <div id="currentTime" style="font-weight:700;font-size:18px"></div>
            <div style="font-size:12px;color:var(--muted)">Hora local</div>
          </div>
        </div>
        <div class="toolbar" style="align-items:center;gap:8px">
          <!-- Icon button: seleccionar día -->
          <button id="btnToggleDay" title="Seleccionar día" aria-label="Seleccionar día" class="icon-btn"> 
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <!-- Botón de ajustes: abre menú para seleccionar horario -->
          <button id="btnOpenSchedules" title="Horario" aria-label="Abrir selector de horarios" class="icon-btn" style="position:relative">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm7.2-3.5c0 .6-.05 1.2-.14 1.8l2.1 1.6a.5.5 0 0 1 .12.66l-2 3.46a.5.5 0 0 1-.61.22l-2.48-1a9.05 9.05 0 0 1-1.56.9l-.38 2.64a.5.5 0 0 1-.5.42h-4a.5.5 0 0 1-.5-.42l-.38-2.64c-.54-.22-1.05-.5-1.55-.83l-2.5 1a.5.5 0 0 1-.62-.2l-2-3.46a.5.5 0 0 1 .12-.66l2.1-1.6c-.09-.6-.14-1.2-.14-1.8s.05-1.2.14-1.8L2.3 8.6a.5.5 0 0 1-.12-.66l2-3.46a.5.5 0 0 1 .62-.2l2.5 1c.5-.33 1.01-.61 1.55-.83L9.6 1.2a.5.5 0 0 1 .5-.42h4c.24 0 .45.16.5.4l.38 2.63c.54.22 1.05.5 1.56.9l2.48-1a.5.5 0 0 1 .62.22l2 3.46a.5.5 0 0 1-.12.66l-2.1 1.6c.09.6.14 1.2.14 1.8z" stroke="currentColor" stroke-width="0" fill="currentColor"/></svg>
          </button>
          <div id="scheduleMenu" style="display:none; position:absolute; right:8px; top:70px; z-index:60; min-width:260px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Seleccionar horario</div>
              <button id="closeScheduleMenu" class="icon-btn" title="Cerrar" aria-label="Cerrar menú" style="width:34px;height:34px;padding:6px">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
            <div class="menu-header">
              <div>
                <div class="menu-title">Seleccionar horario</div>
                <div class="menu-desc">Elige un horario para cargarlo en este equipo. Puedes volver al horario local en cualquier momento.</div>
              </div>
              <div style="font-size:12px;color:var(--muted)">Guardado local</div>
            </div>
            <div id="scheduleList">
              <!-- items cargados por JS -->
            </div>
            <div class="menu-actions">
              <button id="btnResetSchedule" class="ghost">Restablecer local</button>
              <button id="btnCloseMenu" class="chip">Cerrar</button>
            </div>
          </div>
          <!-- Icon button: mostrar/ocultar leyenda -->
          <button id="btnToggleLegend" title="Mostrar leyenda" aria-label="Mostrar legend" class="icon-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16M4 12h10M4 18h7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <!-- Icon button: alternar formato 12/24 -->
          <button id="btnToggleFormat" title="Cambiar formato 12/24" aria-label="Cambiar formato" class="icon-btn">12/24</button>
          <!-- Icon button: alternar tema claro/nocturno (ubicado con los demás botones) -->
          <button id="btnToggleTheme" title="Alternar tema claro/nocturno" aria-label="Alternar tema" class="icon-btn" aria-pressed="false">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g class="icon-sun" fill="currentColor">
                <circle cx="12" cy="12" r="4" />
                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </g>
              <g class="icon-moon" fill="currentColor">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
              </g>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Vista por día (móvil) -->
    <section class="day-view" id="dayView">
      <div class="day-picker" id="dayPicker" style="display:none;">
        <span class="subtitle">Día:</span>
        <select id="daySelect" aria-label="Selecciona día"></select>
      </div>
      <div id="dayCards"></div>
    </section>

    <!-- Vista semanal (escritorio) -->
    <section class="week" id="weekGrid" aria-label="Semana completa">
      <div class="header">
        <div>Hora</div>
        <div>Lunes</div>
        <div>Martes</div>
        <div>Miércoles</div>
        <div>Jueves</div>
        <div>Viernes</div>
      </div>
      <div id="weekBody"></div>
    </section>

    <!-- Leyenda (oculta en móvil, desplegable) -->
    <section class="legend" aria-label="Colores de materias" id="legend">
      <!-- leyenda generada dinámicamente -->
    </section>
  </div>

  <script>
    /* ===================
       Datos del horario
    ==================== */
    const DAYS = ["Lunes","Martes","Miércoles","Jueves","Viernes"]; // sábado vacío
    const EVENTS = [
      // Lunes
      { d:"Lunes", h:"16:00", e:"17:00", t:"Aplicaciones web progresivas", a:"CC10/CECADEC", p:"José Christian Narváez Figueroa", k:"apps" },
      { d:"Lunes", h:"17:00", e:"18:00", t:"Aplicaciones web progresivas", a:"CC10/CECADEC", p:"José Christian Narváez Figueroa", k:"apps" },
      { d:"Lunes", h:"18:00", e:"19:00", t:"Gestión Proc. Des. Soft", a:"CC1/CEDIM", p:"Ángel Yazveck Alcocer Durán", k:"gestion" },
      { d:"Lunes", h:"19:00", e:"20:00", t:"Optativa I: Creación de videojuegos", a:"CC11/D4", p:"David Navas Landa", k:"optativa" },
      { d:"Lunes", h:"20:00", e:"21:00", t:"Desarrollo móvil integral", a:"CC2/CEDIM", p:"Maximiliano Carsi Castrejón", k:"movil" },
      // Martes
      { d:"Martes", h:"15:00", e:"16:00", t:"Inglés IX", a:"A1/D1", p:"Sughey Adriana Moreno Arellano", k:"ingles" },
      { d:"Martes", h:"16:00", e:"17:00", t:"Aplicaciones web progresivas", a:"CC10/CECADEC", p:"José Christian Narváez Figueroa", k:"apps" },
      { d:"Martes", h:"17:00", e:"18:00", t:"Optativa I: Creación de videojuegos", a:"CC11/D4", p:"David Navas Landa", k:"optativa" },
      { d:"Martes", h:"18:00", e:"19:00", t:"Optativa I: Creación de videojuegos", a:"CC11/D4", p:"David Navas Landa", k:"optativa" },
      { d:"Martes", h:"19:00", e:"20:00", t:"Desarrollo móvil integral", a:"CA3/D4", p:"Maximiliano Carsi Castrejón", k:"movil" },
      { d:"Martes", h:"20:00", e:"21:00", t:"Desarrollo móvil integral", a:"CA3/D4", p:"Maximiliano Carsi Castrejón", k:"movil" },
      // Miércoles
      { d:"Miércoles", h:"16:00", e:"17:00", t:"Gestión Proc. Des. Soft", a:"CC11/D4", p:"Ángel Yazveck Alcocer Durán", k:"gestion" },
      { d:"Miércoles", h:"17:00", e:"18:00", t:"Inglés IX", a:"A5/D1", p:"Sughey Adriana Moreno Arellano", k:"ingles" },
      { d:"Miércoles", h:"18:00", e:"19:00", t:"Inglés IX", a:"A5/D1", p:"Sughey Adriana Moreno Arellano", k:"ingles" },
      { d:"Miércoles", h:"19:00", e:"20:00", t:"Negociación empresarial", a:"A4/D1", p:"Alfredo Hugo Silva García", k:"nego" },
      { d:"Miércoles", h:"20:00", e:"21:00", t:"Optativa I: Creación de videojuegos", a:"CC11/D4", p:"David Navas Landa", k:"optativa" },
      // Jueves
      { d:"Jueves", h:"17:00", e:"18:00", t:"Integradora", a:"A6/D1", p:"Alfonso Bahena Ramírez", k:"integ" },
      { d:"Jueves", h:"18:00", e:"19:00", t:"Integradora", a:"A6/D1", p:"Alfonso Bahena Ramírez", k:"integ" },
      { d:"Jueves", h:"19:00", e:"20:00", t:"Desarrollo móvil integral", a:"CC2/CEDIM", p:"Maximiliano Carsi Castrejón", k:"movil" },
      { d:"Jueves", h:"20:00", e:"21:00", t:"Desarrollo móvil integral", a:"CC2/CEDIM", p:"Maximiliano Carsi Castrejón", k:"movil" },
      // Viernes
      { d:"Viernes", h:"15:00", e:"16:00", t:"Inglés IX", a:"A9/D1", p:"Sughey Adriana Moreno Arellano", k:"ingles" },
      { d:"Viernes", h:"16:00", e:"17:00", t:"Desarrollo móvil integral", a:"CC1/CEDIM", p:"Maximiliano Carsi Castrejón", k:"movil" },
      { d:"Viernes", h:"17:00", e:"18:00", t:"Negociación empresarial", a:"Sala 4 Doc 4", p:"Alfredo Hugo Silva García", k:"nego" },
      { d:"Viernes", h:"18:00", e:"19:00", t:"Gestión Proc. Des. Soft", a:"CC10/CECADEC", p:"Ángel Yazveck Alcocer Durán", k:"gestion" },
      { d:"Viernes", h:"19:00", e:"20:00", t:"Gestión Proc. Des. Soft", a:"CC10/CECADEC", p:"Ángel Yazveck Alcocer Durán", k:"gestion" },
    ];

  /* Utilidades */
  const toMin = (s)=>{const [h,m]=s.split(":").map(Number); return h*60+m};
  const fmt = (n)=> String(n).padStart(2,"0");
  // Formato hora: 12 o 24 (persistente)
  function getHourFormat(){ return localStorage.getItem('hourFormat') || '12'; }
  function toggleHourFormat(){ const f = getHourFormat() === '12' ? '24' : '12'; localStorage.setItem('hourFormat', f); return f; }
  function formatTime(t){ const [H,M]=t.split(':').map(Number); if(getHourFormat()==='24') return `${String(H).padStart(2,'0')}:${String(M).padStart(2,'0')}`; const am = H<12; const h = ((H+11)%12)+1; return `${h}:${String(M).padStart(2,'0')} ${am? 'AM':'PM'}`; }

    /* ====== Day View (móvil) ====== */
    const daySel = document.getElementById('daySelect');
    const dayCards = document.getElementById('dayCards');
    DAYS.forEach(d=>{const o=document.createElement('option'); o.value=d; o.textContent=d; daySel.appendChild(o)});

    // Modo de prueba: forzar Jueves 17:00 (slotIndex 2)
    // Úsalo sólo mientras pruebas; deja el reloj con hora real.
    const TEST_OVERRIDE = { enabled: false, dayIndex: 3, slotIndex: 2 };

    /* ====== Multi-horario: cargar JSON desde data/ ====== */
    // index.json contiene lista de horarios disponibles
    const SCHEDULE_INDEX = 'data/index.json';

    function applyScheduleObj(obj){
      try{
        if(!obj) return;
        // aplicar días y horas si vienen — mutar los arrays existentes (DAYS/HOURS/EVENTS son const)
        if(Array.isArray(obj.days) && obj.days.length) {
          DAYS.length = 0; obj.days.forEach(d=> DAYS.push(d));
        }
        if(Array.isArray(obj.hours) && obj.hours.length) {
          HOURS.length = 0; obj.hours.forEach(h=> HOURS.push(h));
        }
        if(Array.isArray(obj.events) && obj.events.length){
          // Reemplazar EVENTS por el que viene en el JSON (mutando)
          EVENTS.length = 0;
          obj.events.forEach(ev=> EVENTS.push(ev));
        }
        // reconstruir UI dependiente
        // actualizar daySelect options
        daySel.innerHTML = '';
        DAYS.forEach(d=>{const o=document.createElement('option'); o.value=d; o.textContent=d; daySel.appendChild(o)});
  // re-render
  buildLegend();
  renderWeek();
  // use detectNow so local day (weekend) is respected
  detectNow();
      }catch(err){ console.error('applyScheduleObj error', err); }
    }

    function createScheduleItem(name, file, selected){
      const item = document.createElement('div'); item.className='schedule-item';
      if(selected) item.classList.add('selected');
      item.dataset.file = file || '__local';
      const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
      const title = document.createElement('div'); title.textContent = name; title.style.fontWeight='700';
      const meta = document.createElement('div'); meta.className='schedule-meta'; meta.textContent = file || 'Horario local';
      left.appendChild(title); left.appendChild(meta);
      const right = document.createElement('div');
      const btn = document.createElement('button'); btn.className='chip'; btn.textContent = selected ? 'Seleccionado' : 'Cargar';
      btn.style.fontSize='12px'; btn.addEventListener('click', ()=>{
        // aplicar
        if(file && file !== '__local') loadScheduleFile(file);
        else { localStorage.removeItem('selectedSchedule'); location.reload(); }
      });
      right.appendChild(btn);
      item.appendChild(left); item.appendChild(right);
      return item;
    }

    function loadSchedulesIndex(){
      fetch(SCHEDULE_INDEX).then(r=>{
        if(!r.ok) throw new Error('index not found');
        return r.json();
      }).then(list=>{
        const container = document.getElementById('scheduleList');
        container.innerHTML = '';
        const prev = localStorage.getItem('selectedSchedule');
        // añadir item local primero
        container.appendChild(createScheduleItem('Horario local (por defecto)', '__local', !prev || prev==='__local'));
        list.forEach(item=>{
          const isSel = prev && prev === item.file;
          const node = createScheduleItem(item.name, item.file, isSel);
          container.appendChild(node);
        });
        // si hay selección previa cargarla
        if(prev && prev !== '__local') loadScheduleFile(prev);
      }).catch(err=>{
        console.info('No index.json de horarios o error al cargar:', err);
        // mostrar al menos opción local
        const container = document.getElementById('scheduleList'); if(container) container.innerHTML = '';
        container && container.appendChild(createScheduleItem('Horario local (por defecto)', '__local', true));
      });
    }

    function loadScheduleFile(path){
      fetch(path).then(r=>{ if(!r.ok) throw new Error('schedule not found'); return r.json(); }).then(obj=>{
        applyScheduleObj(obj);
        try{ localStorage.setItem('selectedSchedule', path); }catch(e){}
      }).catch(err=>{
        console.error('Error cargando horario', path, err);
      });
    }

    // manejar reset/close botones del menú
    document.getElementById('btnResetSchedule').addEventListener('click', ()=>{ localStorage.removeItem('selectedSchedule'); location.reload(); });
    document.getElementById('btnCloseMenu').addEventListener('click', ()=>{ const m = document.getElementById('scheduleMenu'); if(m) m.style.display='none'; });

    // iniciar carga de index (async). Si falla, quedan los datos inline como fallback.
    loadSchedulesIndex();

    // Toggle del menú de selección de horarios (abrir/cerrar)
    const btnOpenSchedules = document.getElementById('btnOpenSchedules');
    const scheduleMenu = document.getElementById('scheduleMenu');
    const closeScheduleMenu = document.getElementById('closeScheduleMenu');
    if(btnOpenSchedules && scheduleMenu){
      btnOpenSchedules.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        if(scheduleMenu.style.display === 'flex'){
          scheduleMenu.classList.remove('show');
          setTimeout(()=> scheduleMenu.style.display='none', 180);
        } else {
          scheduleMenu.style.display = 'flex';
          // allow layout then animate
          setTimeout(()=> scheduleMenu.classList.add('show'), 10);
        }
      });
      closeScheduleMenu && closeScheduleMenu.addEventListener('click', ()=>{ scheduleMenu.classList.remove('show'); setTimeout(()=> scheduleMenu.style.display='none', 180); });
      // cerrar al hacer click fuera
      document.addEventListener('click', (ev)=>{ if(scheduleMenu.style.display==='flex' && !scheduleMenu.contains(ev.target) && ev.target !== btnOpenSchedules){ scheduleMenu.classList.remove('show'); setTimeout(()=> scheduleMenu.style.display='none', 180); } });
      // evitar que el click dentro cierre el menú
      scheduleMenu.addEventListener('click', (ev)=> ev.stopPropagation());
    }

    // Delegated handler: asegurar que cualquier botón creado dinámicamente con id 'btnGotoStartWeek' funcione
    document.addEventListener('click', (ev)=>{
      try{
        const el = ev.target && ev.target.closest ? ev.target.closest('#btnGotoStartWeek') : null;
        if(el){
          console.debug('[debug] delegated click on #btnGotoStartWeek');
          ev.preventDefault(); gotoStartOfWeek();
        }
      }catch(e){ /* no bloquear */ }
    });

    function getTestNowMin(){
      if(TEST_OVERRIDE && TEST_OVERRIDE.enabled){
        // usar la hora de la franja en HOURS (definida más abajo). Si HOURS aún no existe, calcular desde HORARIO.times
        const slot = (typeof HOURS !== 'undefined' && HOURS[TEST_OVERRIDE.slotIndex]) ? HOURS[TEST_OVERRIDE.slotIndex] : (HORARIO && HORARIO.times && HORARIO.times[TEST_OVERRIDE.slotIndex] ? HORARIO.times[TEST_OVERRIDE.slotIndex].split('-')[0].trim() : null);
        if(slot) return toMin(slot) + 1; // +1 para caer dentro del rango
      }
      const now = new Date(); return now.getHours()*60 + now.getMinutes();
    }

    function renderDay(day, highlightNow=true){
      // intentar seleccionar el día en el select; si no existe, crear una opción temporal para mostrar el nombre local
      // eliminar temp previa
      const prevTemp = document.getElementById('tempDayOption'); if(prevTemp) prevTemp.remove();
      const exists = Array.from(daySel.options).some(o=> o.value === day);
      if(exists){ daySel.value = day; }
      else { const opt = document.createElement('option'); opt.value = day; opt.textContent = day; opt.id = 'tempDayOption'; opt.selected = true; opt.disabled = true; daySel.appendChild(opt); }
      dayCards.innerHTML = '';
      const list = EVENTS.filter(e=>e.d===day).sort((a,b)=> toMin(a.h)-toMin(b.h));
  const nowMin = getTestNowMin();
      let scrolled=false;
      // Marcadores calculados: obtener índices de eventos que están ahora, near, next
      const marks = computeNowHighlight(list, nowMin, highlightNow);
      // Si el evento actual y el siguiente son la misma materia, queremos que la siguiente alumbre leve.
      const extraNext = new Set();
      for(const i of Array.from(marks.nowIndexes)){
        if(i+1 < list.length){
          const cur = list[i].t && list[i].t.trim();
          const nxt = list[i+1].t && list[i+1].t.trim();
          if(cur && nxt && cur === nxt) extraNext.add(i+1);
        }
      }
  // decidir índice 'nearest' a animar cuando NO hay now
      let nearestIndex = -1;
      if(marks.nowIndexes.size===0){
        // preferir near si existe, sino next
        if(marks.nearIndexes.size>0){ nearestIndex = Math.min(...Array.from(marks.nearIndexes)); }
        else if(marks.nextIndexes.size>0){ nearestIndex = Math.min(...Array.from(marks.nextIndexes)); }
      }
      list.forEach((ev, idx)=>{
        const card = document.createElement('div');
        card.className = 'card';
  // No añadir la clase de materia directamente (ev.k) porque hay reglas globales
  // como `.apps { background: ... }` que afectan el modo nocturno. En su lugar
  // guardamos el identificador en data-subject y usamos --subject-bg para el overlay.
  if(ev.k) card.dataset.subject = ev.k;
        // aplicar clases según marks: dim por defecto
        card.classList.add('dim');
        if(marks.nowIndexes.has(idx)){
          // evento actual: siempre animar fuerte
          card.classList.remove('dim'); card.classList.add('now'); card.classList.add('animated');
        } else if(extraNext.has(idx)){
          // siguiente con misma materia: resaltar leve
          card.classList.remove('dim'); card.classList.add('next'); card.classList.add('animated');
        } else if(nearestIndex===idx){
          // no hay now: animar solo la clase más cercana
          // marcar como near si estaba dentro del umbral, si no usar 'next'
          if(marks.nearIndexes.has(idx)){
            card.classList.remove('dim'); card.classList.add('near'); card.classList.add('animated');
          } else {
            card.classList.remove('dim'); card.classList.add('next'); card.classList.add('animated');
          }
        } else if(marks.nearIndexes.has(idx)){
          // otros cercanos sin animación
          card.classList.remove('dim'); card.classList.add('near');
        } else if(marks.nextIndexes.has(idx)){
          card.classList.remove('dim'); card.classList.add('next');
        }
  const when = formatTime(ev.h) + ' – ' + formatTime(ev.e);
        card.innerHTML = `
          <div class="title">${ev.t}</div>
          <div class="meta">${when} · <span class="chip">${ev.a}</span></div>
          <div class="meta" style="margin-top:6px">${ev.p}</div>
          <span class="badge ${ev.k}">${ev.d}</span>
        `;
        // establecer una variable CSS --subject-bg con el fondo de la materia para uso en tema claro
        try{
          const cssVarMap = { integ: 'integradora' };
          const varName = cssVarMap[ev.k] || ev.k;
          let bgVal = getComputedStyle(document.documentElement).getPropertyValue(`--c-${varName}`) || '';
          if(!bgVal || !bgVal.trim()){
            const tmp = document.createElement('div'); tmp.style.display='none'; tmp.className = ev.k; document.body.appendChild(tmp);
            bgVal = getComputedStyle(tmp).background || '';
            document.body.removeChild(tmp);
          }
          if(bgVal && bgVal.trim()) card.style.setProperty('--subject-bg', bgVal.trim());
            // establecer un color sólido de acento para usos como box-shadow/borde en modo diurno
            const accentMap = {
              apps: '#00a974',
              gestion: '#1979e0',
              movil: '#4b45ff',
              integradora: '#ff6fb1',
              optativa: '#9a00ff',
              nego: '#ff6f52',
              ingles: '#07b59a'
            };
            const cssKey = (cssVarMap[ev.k] || ev.k) || ev.k;
            const accent = accentMap[cssKey] || '#7d5bff';
            // crear una versión con alpha (hex 8 dígitos) para sombras más visibles en modo claro
            const accentAlpha = (accent.length === 7) ? (accent + 'CC') : accent;
            card.style.setProperty('--subject-accent', accentAlpha);
            card.style.setProperty('--subject-accent-solid', accent);
        }catch(e){/* noop */}
        // scroll al primer ahora
        if(marks.firstNowIndex===idx && !scrolled){
          // usar 'nearest' para evitar que el scroll centre la tarjeta y cause
          // desalineación visual con el encabezado fijo/fluido en dispositivos móviles
          setTimeout(()=> card.scrollIntoView({behavior:'smooth', block:'nearest'}), 50);
          scrolled=true;
        }
        dayCards.appendChild(card);
      });
      if(list.length===0){
        const empty=document.createElement('div');
        empty.className='card';
        // Mensaje contextual según el día
        const isWeekend = (day === 'Sábado' || day === 'Domingo');
        const title = isWeekend ? 'Hoy descansas 🛌' : 'Sin clases hoy';
        const sub = isWeekend ? 'No tienes clases programadas para este día. ¡Aprovéchalo para descansar o avanzar en proyectos!' : 'Parece que no tienes clases registradas para este día. ¿Quieres ver el inicio de la semana?';
        empty.innerHTML=`
          <div class="title">${title}</div>
          <div class="meta">${sub}</div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button id="btnGotoStartWeek" type="button" class="chip" aria-live="polite" onclick="gotoStartOfWeek();">
              <span class="spinner" aria-hidden="true" style="display:none"></span>
              <span class="btn-text">Ver inicio de semana</span>
            </button>
          </div>
        `;
        // comportamiento: botón para navegar al inicio de la semana (con animación de carga)
        const btn = empty.querySelector('#btnGotoStartWeek');
        if(btn){
          btn.addEventListener('click', ()=>{
            try{
              const spinner = btn.querySelector('.spinner');
              const txt = btn.querySelector('.btn-text');
              // mostrar spinner
              if(spinner) spinner.style.display = 'inline-block';
              btn.classList.add('loading');
              if(txt) txt.textContent = 'Cargando...';
              // ejecutar la acción (gotoStartOfWeek es rápida, pero mantenemos el estado un momento)
              gotoStartOfWeek();
              // reactivar después de 1s (suficiente para la animación de la vista)
              setTimeout(()=>{
                if(spinner) spinner.style.display = 'none';
                btn.classList.remove('loading');
                if(txt) txt.textContent = 'Ver inicio de semana';
              }, 1000);
            }catch(e){ console.error(e); }
          });
        }
        dayCards.appendChild(empty);
      }
    }

    daySel.addEventListener('change', e=> renderDay(e.target.value, false));

    /* ====== Week Grid (escritorio) ====== */
    const weekBody = document.getElementById('weekBody');
  const HOURS = ["15:00","16:00","17:00","18:00","19:00","20:00"]; // filas

    function renderWeek(){
      weekBody.innerHTML='';
      const nowMin = getTestNowMin();
      const localDay = localWeekdayName();
      HOURS.forEach(hr=>{
        const row = document.createElement('div'); row.className = 'row';
        const hourCell = document.createElement('div'); hourCell.className = 'hour'; hourCell.textContent = to12(hr); row.appendChild(hourCell);
        DAYS.forEach(day=>{
          const cell = document.createElement('div'); cell.className = 'cell';
          const items = EVENTS.filter(e=>e.d===day && e.h===hr);
          // compute marks for this day's items to decide nearest
          const dayList = EVENTS.filter(e=>e.d===day).sort((a,b)=> toMin(a.h)-toMin(b.h));
          // solo permitir detección "now"/animada si es el día local
          const isToday = (day === localDay);
          const dayMarks = computeNowHighlight(dayList, nowMin, isToday);
          let nearestIdxForDay = -1;
          if(dayMarks.nowIndexes.size===0){
            if(dayMarks.nearIndexes.size>0) nearestIdxForDay = Math.min(...Array.from(dayMarks.nearIndexes));
            else if(dayMarks.nextIndexes.size>0) nearestIdxForDay = Math.min(...Array.from(dayMarks.nextIndexes));
          }
          items.forEach(ev=>{
            const mini = document.createElement('div'); mini.className = `mini ${ev.k} dim`;
            // set background from CSS variable, with mapping fallback
            const cssVarMap = { integ: 'integradora' };
            const varName = cssVarMap[ev.k] || ev.k;
            let bgVal = getComputedStyle(document.documentElement).getPropertyValue(`--c-${varName}`) || '';
            if(!bgVal || !bgVal.trim()){
              const tmp = document.createElement('div'); tmp.style.display='none'; tmp.className = ev.k; document.body.appendChild(tmp);
              bgVal = getComputedStyle(tmp).background || '';
              document.body.removeChild(tmp);
            }
            if(bgVal && bgVal.trim()) mini.style.background = bgVal.trim();
          const when = formatTime(ev.h) + ' – ' + formatTime(ev.e);
            // detectar estado ahora / cerca para la mini-card
            const start = toMin(ev.h), end = toMin(ev.e);
            if(nowMin >= start && nowMin < end){
              mini.classList.remove('dim'); mini.classList.add('now');
              if(isToday) mini.classList.add('animated');
            } else {
              // find index of this ev within dayList to compare with nearestIdxForDay
              const idxInDay = dayList.findIndex(x=> x.h===ev.h && x.t===ev.t && x.a===ev.a);
              if(nearestIdxForDay===idxInDay){
                // nearest upcoming: always mark near/next but animate only on today's column
                if(dayMarks.nearIndexes.has(idxInDay)) mini.classList.remove('dim'), mini.classList.add('near');
                else mini.classList.remove('dim'), mini.classList.add('next');
                if(isToday) mini.classList.add('animated');
              } else if(nowMin < start && (start - nowMin) <= 20){
                mini.classList.remove('dim'); mini.classList.add('near');
              } else if(nowMin < start){
                mini.classList.remove('dim'); mini.classList.add('next');
              }
            }
            mini.innerHTML = `<div>${ev.t}</div><span class="when">${when}</span><span class="room">${ev.a}</span>`;
            cell.appendChild(mini);
          });
          row.appendChild(cell);
        });
        weekBody.appendChild(row);
      });
    }

    /* ====== Detección de día/hora actual ====== */
    function todayIndex(){
      const i = new Date().getDay(); // 0=Dom,1=Lun…
      return Math.min(Math.max(i-1,0),4); // 0..4 (fallback to weekdays)
    }
    // Nombre del día local capitalizado (ej. 'Sábado')
    function localWeekdayName(){
      try{ const now = new Date(); const wd = now.toLocaleDateString(undefined, { weekday: 'long' }); return wd.charAt(0).toUpperCase() + wd.slice(1); }catch(e){ return DAYS[todayIndex()]; }
    }
    function dayIndexFromName(n){ return DAYS.indexOf(n); }

    function detectNow(){
      // usar siempre el día local del sistema (esto permite mostrar "Hoy descansas" si no hay eventos)
      const localDay = localWeekdayName();
      const d = (TEST_OVERRIDE && TEST_OVERRIDE.enabled) ? DAYS[TEST_OVERRIDE.dayIndex] : localDay;
      renderDay(d, true);
    }

    /* Navegar al inicio de la semana (día 0) — muestra día o la vista semanal según ancho */
    function gotoStartOfWeek(){
      const first = DAYS[0] || 'Lunes';
      // si estamos en escritorio, mostrar la vista semanal y resaltar la columna
      if(window.matchMedia && window.matchMedia('(min-width:900px)').matches){
        renderWeek();
        // resaltar columna correspondiente al primer día por 2.5s
        const header = document.querySelector('.week .header');
        if(header){
          // header children: [Hora, Lunes, Martes, ...]
          const cols = Array.from(header.children);
          let colIndex = cols.findIndex(n=> n.textContent.trim() === first);
          if(colIndex >= 0){
            const hdr = cols[colIndex]; hdr.classList.add('start-highlight');
            // resaltar las celdas de cada fila en esa columna
            const rows = document.querySelectorAll('.week .row');
            rows.forEach(r=>{ const cell = r.children[colIndex]; if(cell) cell.classList.add('start-highlight'); });
            // scroll to week container top
            const w = document.querySelector('.week'); if(w) w.scrollIntoView({behavior:'smooth', block:'start'});
            setTimeout(()=>{
              hdr.classList.remove('start-highlight');
              rows.forEach(r=>{ const cell = r.children[colIndex]; if(cell) cell.classList.remove('start-highlight'); });
            }, 2500);
          }
        }
      } else {
        // móvil: mostrar el día en la vista por día
          // si existe select, setear el valor
          const sel = document.getElementById('daySelect');
          if(sel){ const opt = Array.from(sel.options).find(o=> o.value === first); if(opt) sel.value = first; }
          // sólo activar el resaltado/animación si el primer día coincide con el día local
          const localDayName = localWeekdayName();
          renderDay(first, first === localDayName);
        // asegurar que la sección day-view esté visible (si el CSS cambia entre mobile/desktop)
        const dv = document.getElementById('dayView'); if(dv) dv.scrollIntoView({behavior:'smooth', block:'start'});
      }
    }

    // Toggle selector de día (móvil)
    document.getElementById('btnToggleDay').addEventListener('click', ()=>{
      const dp = document.getElementById('dayPicker'); if(!dp) return; dp.style.display = dp.style.display==='none'? 'flex':'none';
    });

    // Inicializar UI
  renderWeek();
  detectNow();
    // iniciar reloj y resaltado periódicos (cada 15s) — usar detectNow para respetar día local
  updateClock();
  setInterval(()=>{ updateClock(); detectNow(); }, 15000);
    // Generar leyenda dinámica: materia -> profesores
    function buildLegend(){
      const map = new Map();
      EVENTS.forEach(ev=>{
        const key = ev.t;
        if(!map.has(key)) map.set(key, {prof: new Set(), k: ev.k});
        map.get(key).prof.add(ev.p);
      });
      const legend = document.getElementById('legend');
      legend.innerHTML = '';
      // mapping short keys to actual CSS variable suffix when they differ
      const cssVarMapLegend = { integ: 'integradora' };
      map.forEach((v, subject)=>{
        const item = document.createElement('div'); item.className='item';
        const sw = document.createElement('span'); sw.className='swatch';
        // try CSS variable first
        const varName = cssVarMapLegend[v.k] || v.k;
        let bg = getComputedStyle(document.documentElement).getPropertyValue(`--c-${varName}`);
        if(!bg || !bg.trim()){
          // fallback: try reading computed background from an element with the same class
          const tmp = document.createElement('div'); tmp.style.display='none'; tmp.className = v.k; document.body.appendChild(tmp);
          bg = getComputedStyle(tmp).background || '';
          document.body.removeChild(tmp);
        }
        sw.style.background = (bg && bg.trim()) ? bg.trim() : '#666';
        const txt = document.createElement('div'); txt.innerHTML = `<strong>${subject}</strong><div style="font-size:12px;color:var(--muted)">${Array.from(v.prof).join(', ')}</div>`;
        item.appendChild(sw); item.appendChild(txt); legend.appendChild(item);
      });
    }
    buildLegend();

    // Legend toggle
    document.getElementById('btnToggleLegend').addEventListener('click', ()=>{
      const lg = document.getElementById('legend'); if(!lg) return; lg.classList.toggle('open');
    });

    // Format toggle
    const fmtBtn = document.getElementById('btnToggleFormat');
  if(fmtBtn){ fmtBtn.addEventListener('click', ()=>{ const f = toggleHourFormat(); fmtBtn.textContent = f==='12' ? '12/24' : '24/12'; renderWeek(); detectNow(); }); }

    // util: convertir 24h "HH:MM" a 12h "h:MM AM/PM"
    function to12(t){
      const [H,M]=t.split(':').map(Number);
      const am = H<12; const h = ((H+11)%12)+1; return `${h}:${String(M).padStart(2,'0')} ${am? 'AM':'PM'}`;
    }

    // Actualiza el header con día, fecha y hora locales
    function updateClock(){
      const now = new Date();
      const dayName = localWeekdayName();
      const dateStr = now.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'short', day:'numeric'});
      const timeStr = now.toLocaleTimeString(undefined, {hour:'numeric', minute:'2-digit'});
      const dayEl = document.getElementById('currentDay');
      const dateEl = document.getElementById('currentDate');
      const timeEl = document.getElementById('currentTime');
      if(dayEl) dayEl.textContent = dayName;
      if(dateEl) dateEl.textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
      if(timeEl) timeEl.textContent = timeStr;
    }

    

    // Determina índices de eventos actuales y siguientes en la lista (por orden)
    // Clasifica en: nowIndexes (actual), nearIndexes (poco antes), nextIndexes (la siguiente después de now), dim por defecto
    function computeNowHighlight(list, nowMin, highlightNow){
      const nowIndexes = new Set();
      const nearIndexes = new Set();
      const nextIndexes = new Set();
      let firstNowIndex = -1;
      // Umbrales (minutos)
      const nearThreshold = 20; // minutos antes

      // helper: normalizar títulos para comparación tolerante
      const norm = s => (s||'').toLowerCase().replace(/\(.*?\)/g,'').replace(/[^a-z0-9\s]+/g,'').trim();

      // Normaliza intervalos y admite eventos que crucen la medianoche
      const normalizeTimes = (startStr, endStr) => {
        let s = toMin(startStr), e = toMin(endStr);
        if(e <= s) e += 24*60; // evento cruza a la siguiente jornada
        return [s,e];
      };

      // Consideramos también nowMin + 24*60 para detectar en cruces de día
      const nowAlt = nowMin + 24*60;

      // buscar índice del evento actual (si existe) — solo marcar now si highlightNow === true
      let nowIndex = -1;
      for(let i=0;i<list.length;i++){
        const ev = list[i];
        const [start, end] = normalizeTimes(ev.h, ev.e);
        if((nowMin >= start && nowMin < end) || (nowAlt >= start && nowAlt < end)){
          nowIndex = i; break;
        }
      }

      if(nowIndex !== -1 && highlightNow){
        firstNowIndex = nowIndex;
        // marcar el bloque consecutivo con el mismo título como 'now'
        const base = norm(list[nowIndex].t);
        let j = nowIndex;
        while(j < list.length && norm(list[j].t) === base){ nowIndexes.add(j); j++; }
        // la primera siguiente distinta (si existe) marcar como next
        if(j < list.length) nextIndexes.add(j);
        return {nowIndexes, nearIndexes, nextIndexes, firstNowIndex};
      }

      // Si no hay 'now' (o no está permitido), marcar near (dentro de umbral) y next (primer futuro)
      for(let i=0;i<list.length;i++){
        const ev = list[i];
        let [start, end] = normalizeTimes(ev.h, ev.e);
        // near: dentro de threshold (considerando now y nowAlt)
        if((nowMin < start && (start - nowMin) <= nearThreshold) || (nowAlt < start && (start - nowAlt) <= nearThreshold)){
          nearIndexes.add(i);
        }
        // next: primer futuro (considerando nowAlt)
        if(((nowMin < start) || (nowAlt < start)) && nextIndexes.size===0){ nextIndexes.add(i); }
      }
      return {nowIndexes, nearIndexes, nextIndexes, firstNowIndex};
    }
  </script>
  <script>
    // Theme (diurno/nocturno) toggle
    (function(){
      const THEME_KEY = 'themePref'; // 'light' or 'dark' (if absent => follow system)
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      function getSaved(){ try{ return localStorage.getItem(THEME_KEY); }catch(e){return null} }
      function detectSystem(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
      function applyTheme(t){
        if(t === 'light') {
          document.body.classList.add('light-theme');
        } else {
          document.body.classList.remove('light-theme');
        }
        // update meta theme-color for mobile UI
        try{
          if(metaTheme){ metaTheme.setAttribute('content', t === 'light' ? '#f6f9ff' : '#0b0f17'); }
        }catch(e){}
        // update aria-pressed
        const btn = document.getElementById('btnToggleTheme'); if(btn) btn.setAttribute('aria-pressed', t === 'dark' ? 'true' : 'false');
      }
      function initTheme(){
        const saved = getSaved();
        if(saved){ applyTheme(saved); }
        else { applyTheme(detectSystem()); }
        // listen to system changes only when user hasn't chosen a pref
        if(!saved && window.matchMedia){
          const mq = window.matchMedia('(prefers-color-scheme: dark)');
          const listener = (e)=> applyTheme(e.matches ? 'dark' : 'light');
          if(mq.addEventListener) mq.addEventListener('change', listener);
          else if(mq.addListener) mq.addListener(listener);
        }
      }
      function toggleTheme(){
        const saved = getSaved();
        let next;
        if(saved){ next = saved === 'light' ? 'dark' : 'light'; }
        else { next = document.body.classList.contains('light-theme') ? 'dark' : 'light'; }
        try{ localStorage.setItem(THEME_KEY, next); }catch(e){}
        applyTheme(next);
      }
      // attach
      const btn = document.getElementById('btnToggleTheme'); if(btn){ btn.addEventListener('click', ()=> toggleTheme()); }
      // init immediately
      initTheme();
    })();
  </script>
  <script src="./register.js"></script>
</body>
</html>